<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Para voc√™ üíõ</title>
  <style>
    :root{
      --bg1:#0b0b10; --bg2:#141428;
      --card:#121225cc; --stroke:#ffffff22;
      --text:#f5f5ff; --muted:#c9c9ffcc;
      --accent:#ff5a7a; --accent2:#7cf7ff;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 900px at 20% 0%, #2a1b4d 0%, transparent 55%),
                  radial-gradient(900px 800px at 100% 20%, #0d3f4b 0%, transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding: 18px 14px 26px;
    }
    .app{
      width:min(420px, 100%);
      display:flex; flex-direction:column; gap:14px;
    }
    .top{
      padding: 16px 16px 10px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, #ffffff10, #ffffff06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .glow{
      position:absolute; inset:-2px;
      background: radial-gradient(700px 260px at 30% 0%, #ff5a7a22, transparent 60%),
                  radial-gradient(600px 240px at 90% 30%, #7cf7ff22, transparent 55%);
      filter: blur(0px);
      pointer-events:none;
    }
    h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .sub{ margin:8px 0 0; color:var(--muted); font-size:14px; line-height:1.35; }
    .step{
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .stepHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .badge{
      font-size:12px; color: #ffffffcc;
      padding: 6px 10px; border-radius: 999px;
      background: #ffffff14;
      border:1px solid #ffffff18;
      white-space:nowrap;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .title b{ font-size:15px; }
    .title span{ font-size:12px; color:var(--muted); }
    .content{ padding: 0 14px 14px; }
    .hint{
      font-size:12px; color:var(--muted);
      border:1px dashed #ffffff2a;
      border-radius: 12px;
      padding:10px 10px;
      margin-top:10px;
    }
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid #ffffff20;
      background: linear-gradient(180deg, #ffffff16, #ffffff10);
      color:var(--text);
      font-weight:600;
      font-size:14px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .locked{ opacity:.55; filter:saturate(.8); }
    .divider{ height:1px; background:#ffffff12; margin:10px 0 12px; }

    /* STEP 1 ‚Äì Heart area */
    .heartField{
      position:relative;
      height: 170px;
      border-radius: 16px;
      border:1px solid #ffffff18;
      background:
        radial-gradient(120px 120px at 30% 30%, #ff5a7a18, transparent 60%),
        radial-gradient(140px 140px at 75% 40%, #7cf7ff14, transparent 60%),
        linear-gradient(180deg, #00000025, #00000045);
      overflow:hidden;
    }
    .spark{
      position:absolute; width:8px; height:8px; border-radius:50%;
      background: #ffffffcc;
      box-shadow: 0 0 18px #ffffffaa;
      transform: translate(-50%,-50%);
      opacity:0;
      pointer-events:none;
    }
    .pulse{
      position:absolute; left:50%; top:50%;
      width:14px; height:14px; border-radius:50%;
      transform: translate(-50%,-50%);
      background: var(--accent);
      opacity:0;
      pointer-events:none;
    }
    .pulse.on{
      opacity:.85;
      animation: pulse 1.1s infinite;
      box-shadow: 0 0 28px #ff5a7a88;
    }
    @keyframes pulse{
      0%{ transform:translate(-50%,-50%) scale(1); opacity:.85; }
      70%{ transform:translate(-50%,-50%) scale(3.2); opacity:.08; }
      100%{ transform:translate(-50%,-50%) scale(3.2); opacity:0; }
    }
    .reveal{
      margin-top:12px;
      border-radius: 16px;
      border:1px solid #ffffff18;
      overflow:hidden;
      display:none;
    }
    .reveal img{
      width:100%; height:220px; object-fit:cover; display:block;
      filter: saturate(1.05) contrast(1.02);
    }
    .reveal .cap{
      padding: 12px 12px 12px;
      font-size:14px; line-height:1.35;
    }

    /* STEP 2 ‚Äì Drag fragments */
    .board{
      position:relative;
      height: 270px;
      border-radius: 16px;
      border:1px solid #ffffff18;
      background: linear-gradient(180deg,#0000001a,#00000040);
      overflow:hidden;
      touch-action: none;
    }
    .piece{
      position:absolute;
      width: 40%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      border:1px solid #ffffff18;
      background-size: 200% 200%;
      background-repeat:no-repeat;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      cursor: grab;
      user-select:none;
    }
    .piece:active{ cursor: grabbing; }
    .ghostText{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:#ffffff66; font-size:12px; text-align:center;
      padding:0 18px;
      pointer-events:none;
    }
    .assembled{
      position:absolute;
      inset: 14px;
      border-radius: 16px;
      border:1px solid #ffffff18;
      overflow:hidden;
      display:none;
      background:#000;
    }
    .assembled img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .assembled .overlay{
      position:absolute; left:0; right:0; bottom:0;
      padding: 12px 12px 12px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.65));
      font-size:14px; line-height:1.35;
    }

    /* STEP 3 ‚Äì Hold to unlock */
    .holdWrap{
      border-radius: 16px;
      border:1px solid #ffffff18;
      padding: 14px;
      background: #ffffff08;
    }
    .holdBtn{
      position:relative;
      height: 54px;
      border-radius: 16px;
      border:1px solid #ffffff22;
      background: linear-gradient(180deg, #ffffff16, #ffffff10);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      overflow:hidden;
      user-select:none;
    }
    .bar{
      position:absolute; left:0; top:0; bottom:0;
      width:0%;
      background: linear-gradient(90deg, #ff5a7a66, #7cf7ff55);
      transition: width .06s linear;
    }
    .holdText{ position:relative; z-index:1; }
    .final{
      display:none;
      margin-top:12px;
      border-radius: 16px;
      border:1px solid #ffffff18;
      overflow:hidden;
      background:#00000022;
    }
    .final img{
      width:100%; height:220px; object-fit:cover; display:block;
    }
    .final .letter{
      padding: 14px 14px 16px;
      line-height:1.5;
      font-size:14px;
    }
    .chip{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background:#ffffff14;
      border:1px solid #ffffff18;
      margin: 10px 0 0;
      color:#ffffffdd;
      font-weight:700;
      font-size:12px;
    }
    .small{ font-size:12px; color:var(--muted); margin-top:10px; }

    .doneMark{
      color:#9bffb1;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="glow"></div>
      <h1>Feliz anivers√°rio, <span id="herName">meu amor</span> üíõ</h1>
      <p class="sub">
        Eu fiz isso pra voc√™ ‚Äî uma coisinha que abre devagar‚Ä¶ igual as melhores coisas da vida.
        <br/>Sem respostas, sem press√£o. S√≥ voc√™ descobrindo.
      </p>
    </div>

    <!-- STEP 1 -->
    <section class="step" id="step1">
      <div class="stepHead">
        <div class="title">
          <b>1) Encontre o cora√ß√£o</b>
          <span>Toque na tela‚Ä¶ e preste aten√ß√£o no que ‚Äúresponde‚Äù.</span>
        </div>
        <div class="badge" id="b1">üîí Trancado</div>
      </div>
      <div class="content">
        <div class="heartField" id="heartField" aria-label="√Årea interativa">
          <div class="pulse" id="pulse"></div>
          <div class="spark" id="spark"></div>
        </div>

        <div class="hint">
          Dica: quando voc√™ estiver perto‚Ä¶ vai parecer que a tela est√° ‚Äúviva‚Äù.
        </div>

        <div class="reveal" id="reveal1">
          <img id="photo1" alt="Foto 1" src="https://images.unsplash.com/photo-1520975958225-2ad2f74b9b01?auto=format&fit=crop&w=1200&q=80" />
          <div class="cap" id="cap1">
            <b>Voc√™ √© minha paz e minha bagun√ßa boa.</b><br/>
            E eu adoro como tudo fica mais leve quando √© com voc√™.
          </div>
        </div>

        <div class="divider"></div>
        <button class="btn locked" id="to2" disabled>Continuar ‚Üí</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="step locked" id="step2" aria-disabled="true">
      <div class="stepHead">
        <div class="title">
          <b>2) Junte os fragmentos</b>
          <span>Arraste as pe√ßas at√© elas ‚Äúse entenderem‚Äù.</span>
        </div>
        <div class="badge" id="b2">üîí Trancado</div>
      </div>
      <div class="content">
        <div class="board" id="board">
          <div class="ghostText">As pe√ßas querem se encontrar. S√≥ aproxima‚Ä¶ üíõ</div>

          <div class="piece" id="p1"></div>
          <div class="piece" id="p2"></div>
          <div class="piece" id="p3"></div>

          <div class="assembled" id="assembled">
            <img id="photo2" alt="Foto 2" src="https://images.unsplash.com/photo-1529634898884-7a0c0f2a11f6?auto=format&fit=crop&w=1200&q=80" />
            <div class="overlay" id="cap2">
              <b>Eu guardo voc√™ em detalhes.</b><br/>
              Nos dias bons, nos dias dif√≠ceis, e principalmente nos dias comuns.
            </div>
          </div>
        </div>

        <div class="hint">
          Dica: n√£o precisa encaixar perfeito. Quando estiver perto o suficiente‚Ä¶ acontece.
        </div>

        <div class="divider"></div>
        <button class="btn locked" id="to3" disabled>Ir pro √∫ltimo ‚Üí</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="step locked" id="step3" aria-disabled="true">
      <div class="stepHead">
        <div class="title">
          <b>3) Trava do tempo</b>
          <span>Segura um pouquinho‚Ä¶</span>
        </div>
        <div class="badge" id="b3">üîí Trancado</div>
      </div>
      <div class="content">
        <div class="holdWrap">
          <div class="holdBtn" id="holdBtn">
            <div class="bar" id="bar"></div>
            <div class="holdText" id="holdText">Pressione e segure üíõ</div>
          </div>
          <div class="small">(prometo que vale a pena)</div>
        </div>

        <div class="final" id="final">
          <img id="photo3" alt="Foto final" src="https://images.unsplash.com/photo-1520975682031-a80a56b7b9f5?auto=format&fit=crop&w=1200&q=80" />
          <div class="letter" id="letter">
            <b>Meu amor, feliz anivers√°rio.</b><br/><br/>
            Hoje eu s√≥ quero te lembrar do √≥bvio: voc√™ √© uma das melhores partes da minha vida.
            Obrigado por existir do seu jeitinho, por me escolher, por me ensinar, por me acalmar e por me fazer querer ser melhor.<br/><br/>
            Eu amo voc√™ com calma e com intensidade ‚Äî e eu quero construir mais e mais momentos com voc√™.<br/><br/>
            <span class="chip" id="surprise">üéÅ Seu presente: hoje eu vou te buscar √†s 19:30. Se arruma linda (como sempre) e confia em mim.</span>
            <div class="small">PS: quando voc√™ terminar, me d√° um abra√ßo bem apertado. Eu t√¥ precisando. üôÇ</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ======= CUSTOMIZE HERE =======
    const config = {
      herName: "MEU AMOR",
      photo1: "https://YOUR-PHOTO-LINK-1",
      photo2: "https://YOUR-PHOTO-LINK-2",
      photo3: "https://YOUR-PHOTO-LINK-3",
      cap1: "Voc√™ √© minha paz e minha bagun√ßa boa.<br/>E eu adoro como tudo fica mais leve quando √© com voc√™.",
      cap2: "Eu guardo voc√™ em detalhes.<br/>Nos dias bons, nos dias dif√≠ceis, e principalmente nos dias comuns.",
      letterHTML: `
        <b>Meu amor, feliz anivers√°rio.</b><br/><br/>
        Hoje eu s√≥ quero te lembrar do √≥bvio: voc√™ √© uma das melhores partes da minha vida.
        Obrigado por existir do seu jeitinho, por me escolher, por me ensinar, por me acalmar e por me fazer querer ser melhor.<br/><br/>
        Eu amo voc√™ com calma e com intensidade ‚Äî e eu quero construir mais e mais momentos com voc√™.<br/><br/>
        <span class="chip">üéÅ Seu presente: escreva aqui seu plano (ex: ‚Äúeu vou te buscar √†s 19:30‚Ä¶‚Äù)</span>
        <div class="small">PS: eu te amo. Muito.</div>
      `
    };

    // =================== DEBUG LOGGER ===================
    const DEBUG = true;
    const log = {
      group(label, data){
        if(!DEBUG) return;
        console.group(`%c${label}`, "color:#7cf7ff;font-weight:800");
        if(data) console.log(data);
      },
      end(){ if(DEBUG) console.groupEnd(); },
      info(msg, data){ if(DEBUG) console.log(`%c‚ÑπÔ∏è ${msg}`, "color:#c9c9ff", data ?? ""); },
      ok(msg, data){ if(DEBUG) console.log(`%c‚úÖ ${msg}`, "color:#9bffb1;font-weight:800", data ?? ""); },
      warn(msg, data){ if(DEBUG) console.warn(`‚ö†Ô∏è ${msg}`, data ?? ""); },
      err(msg, data){ if(DEBUG) console.error(`‚ùå ${msg}`, data ?? ""); },
    };

    window.addEventListener("error", (e)=>{
      log.err("window.error", { message: e.message, file: e.filename, line: e.lineno, col: e.colno });
    });
    window.addEventListener("unhandledrejection", (e)=>{
      log.err("unhandledrejection", e.reason);
    });

    // Apply customization if user replaced links
    const $ = (id) => document.getElementById(id);

    log.group("BOOT");
    log.info("UserAgent", navigator.userAgent);
    log.info("Viewport", { w: innerWidth, h: innerHeight });
    log.end();

    function must(id){
      const el = $(id);
      if(!el) log.err(`Missing element #${id}`);
      else log.ok(`Found element #${id}`);
      return el;
    }

    // Quick DOM sanity check
    log.group("DOM CHECK");
    [
      "herName","photo1","photo2","photo3",
      "heartField","pulse","spark","reveal1","b1","to2",
      "board","assembled","b2","to3","p1","p2","p3",
      "holdBtn","bar","holdText","final","b3"
    ].forEach(must);
    log.end();

    $("herName").textContent = config.herName;
    log.ok("Set herName", config.herName);

    const safeSetImg = (el, url, fallback) => {
      const id = el?.id || "(no-id)";
      const chosen = (url && url.startsWith("http")) ? url : fallback;

      el.addEventListener("load", () => log.ok(`Image loaded #${id}`, { src: el.src }), { once:true });
      el.addEventListener("error", () => log.err(`Image ERROR #${id}`, { tried: chosen }), { once:true });

      el.src = chosen;
      log.info(`Image set #${id}`, { src: el.src });
    };

    log.group("CONFIG / IMAGES");
    safeSetImg($("photo1"), config.photo1, $("photo1").src);
    safeSetImg($("photo2"), config.photo2, $("photo2").src);
    safeSetImg($("photo3"), config.photo3, $("photo3").src);
    log.end();

    $("cap1").innerHTML = config.cap1;
    $("cap2").innerHTML = config.cap2;
    $("letter").innerHTML = config.letterHTML;
    log.ok("Set captions + letter HTML");

    // ======= STEP 1: find the heart =======
    const heartField = $("heartField");
    const pulse = $("pulse");
    const spark = $("spark");
    const reveal1 = $("reveal1");
    const b1 = $("b1");
    const to2 = $("to2");

    const hotspot = { x: 0.72, y: 0.58 };
    const HOT_RADIUS = 52;

    function getLocalPos(ev){
      const r = heartField.getBoundingClientRect();
      const t = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
      const x = t.clientX - r.left;
      const y = t.clientY - r.top;
      return { x, y, w:r.width, h:r.height };
    }

    function distance(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

    let step1Done = false;

    function updateHeartResponse(pos){
      const target = { x: hotspot.x * pos.w, y: hotspot.y * pos.h };
      const d = distance(pos, target);

      spark.style.left = pos.x + "px";
      spark.style.top  = pos.y + "px";
      spark.style.opacity = 0.9;
      clearTimeout(spark._t);
      spark._t = setTimeout(()=> spark.style.opacity = 0, 140);

      pulse.style.left = target.x + "px";
      pulse.style.top  = target.y + "px";

      if (d < HOT_RADIUS) pulse.classList.add("on");
      else pulse.classList.remove("on");

      return d;
    }

    function completeStep1(){
      log.group("STEP 1: completeStep1()");
      if(step1Done){
        log.warn("Already completed");
        log.end();
        return;
      }
      step1Done = true;
      reveal1.style.display = "block";
      b1.innerHTML = "‚úÖ <span class='doneMark'>Aberto</span>";
      to2.classList.remove("locked");
      to2.disabled = false;

      $("step2").classList.remove("locked");
      $("step2").setAttribute("aria-disabled","false");
      $("b2").textContent = "üîì Liberado";

      log.ok("Step 1 completed -> Step 2 unlocked");
      log.end();
    }

    log.group("STEP 1: init", { hotspot, HOT_RADIUS });
    log.end();

    heartField.addEventListener("touchmove", (e)=> {
      if(step1Done) return;
      const d = updateHeartResponse(getLocalPos(e));
      // spammy logs avoided for move
    }, {passive:true});

    heartField.addEventListener("mousemove", (e)=> {
      if(step1Done) return;
      updateHeartResponse(getLocalPos(e));
    });

    function handleStep1Tap(ev, type){
      if(step1Done) return;
      log.group(`STEP 1: ${type}`);
      const pos = getLocalPos(ev);
      const d = updateHeartResponse(pos);
      log.info("Tap pos", { x: pos.x.toFixed(1), y: pos.y.toFixed(1), w: pos.w.toFixed(1), h: pos.h.toFixed(1) });
      log.info("Distance to hotspot", { d: d.toFixed(1), HOT_RADIUS });
      if(d < HOT_RADIUS){
        log.ok("Within radius -> SUCCESS");
        completeStep1();
      } else {
        log.warn("Outside radius -> FAIL (try closer)");
      }
      log.end();
    }

    heartField.addEventListener("touchstart", (e)=> handleStep1Tap(e, "touchstart"), {passive:true});
    heartField.addEventListener("click", (e)=> handleStep1Tap(e, "click"));

    to2.addEventListener("click", ()=> {
      log.ok("STEP 1: Continue clicked -> scroll to Step 2");
      document.getElementById("step2").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // ======= STEP 2: drag fragments =======
    const board = $("board");
    const assembled = $("assembled");
    const b2 = $("b2");
    const to3 = $("to3");

    const pieceEls = [ $("p1"), $("p2"), $("p3") ];
    const pieceTargets = [
      { x: 0.18, y: 0.14 },
      { x: 0.53, y: 0.28 },
      { x: 0.33, y: 0.55 }
    ];
    const SNAP_DIST = 75;
    let step2Done = false;

    const bgUrl = () => $("photo2").src;

    function layoutPieces(){
      log.group("STEP 2: layoutPieces()");
      const r = board.getBoundingClientRect();
      log.info("Board rect", { w: r.width.toFixed(1), h: r.height.toFixed(1) });
      log.info("bgUrl()", bgUrl());

      const starts = [
        { x: 0.06, y: 0.08 },
        { x: 0.56, y: 0.08 },
        { x: 0.32, y: 0.64 }
      ];

      pieceEls.forEach((el,i)=>{
        const left = (starts[i].x * r.width);
        const top  = (starts[i].y * r.height);
        el.style.left = left + "px";
        el.style.top  = top + "px";

        el.style.backgroundImage = `url(${bgUrl()})`;

        const bx = (i===0? "0%" : i===1? "55%" : "30%");
        const by = (i===0? "10%" : i===1? "20%" : "70%");
        el.style.backgroundPosition = `${bx} ${by}`;
        el.style.backgroundSize = "250% 250%";

        log.ok(`Placed piece p${i+1}`, { left: left.toFixed(1), top: top.toFixed(1), bx, by });
      });

      log.info("Targets", { pieceTargets, SNAP_DIST });
      log.end();
    }

    window.addEventListener("resize", ()=> {
      if(step2Done) return;
      log.warn("Window resized -> re-layout pieces");
      layoutPieces();
    });

    // Ensure layout after photo2 loads (avoids invisible fragments if you change photo2)
    $("photo2").addEventListener("load", ()=> {
      log.ok("photo2 loaded -> layoutPieces()");
      if(!step2Done) layoutPieces();
    }, { once:false });

    // initial layout
    layoutPieces();

    function getPoint(ev){
      const t = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
      const r = board.getBoundingClientRect();
      return { x: t.clientX - r.left, y: t.clientY - r.top, w:r.width, h:r.height };
    }

    let drag = null;

    function startDrag(el, ev){
      if(step2Done) return;
      const p = getPoint(ev);
      const rect = el.getBoundingClientRect();
      const br = board.getBoundingClientRect();

      drag = {
        el,
        offX: p.x - (rect.left - br.left),
        offY: p.y - (rect.top  - br.top),
      };
      el.style.zIndex = 10;

      log.group("STEP 2: startDrag()");
      log.info("Piece", el.id);
      log.info("Pointer", { x: p.x.toFixed(1), y: p.y.toFixed(1) });
      log.info("Offsets", { offX: drag.offX.toFixed(1), offY: drag.offY.toFixed(1) });
      log.end();
    }

    function moveDrag(ev){
      if(!drag || step2Done) return;
      const p = getPoint(ev);
      const x = p.x - drag.offX;
      const y = p.y - drag.offY;
      drag.el.style.left = x + "px";
      drag.el.style.top  = y + "px";
      // no logs here (too spammy)
    }

    function endDrag(){
      if(!drag || step2Done) return;

      log.group("STEP 2: endDrag()");
      log.info("Piece", drag.el.id);
      drag.el.style.zIndex = 1;
      drag = null;
      checkAssemble();
      log.end();
    }

    function centerOf(el){
      const r = el.getBoundingClientRect();
      const br = board.getBoundingClientRect();
      return { x:(r.left-br.left)+(r.width/2), y:(r.top-br.top)+(r.height/2) };
    }

    function checkAssemble(){
      log.group("STEP 2: checkAssemble()");

      const br = board.getBoundingClientRect();
      const dists = [];

      const ok = pieceEls.every((el,i)=>{
        const c = centerOf(el);
        const t = { x: pieceTargets[i].x*br.width, y: pieceTargets[i].y*br.height };
        const dist = Math.hypot(c.x - t.x, c.y - t.y);
        dists.push({ piece: el.id, dist: +dist.toFixed(1), snap: SNAP_DIST });
        return dist < SNAP_DIST;
      });

      log.info("Distances", dists);

      if(ok){
        log.ok("All pieces within SNAP_DIST -> SUCCESS");
        step2Done = true;
        assembled.style.display = "block";
        pieceEls.forEach(el => el.style.display = "none");
        b2.innerHTML = "‚úÖ <span class='doneMark'>Aberto</span>";
        to3.classList.remove("locked");
        to3.disabled = false;

        $("step3").classList.remove("locked");
        $("step3").setAttribute("aria-disabled","false");
        $("b3").textContent = "üîì Liberado";

        log.ok("Step 2 completed -> Step 3 unlocked");
      } else {
        log.warn("Not assembled yet -> FAIL (keep dragging closer)");
      }

      log.end();
    }

    pieceEls.forEach(el=>{
      el.addEventListener("touchstart", (e)=> startDrag(el,e), {passive:true});
      el.addEventListener("mousedown", (e)=> startDrag(el,e));
    });
    board.addEventListener("touchmove", (e)=> { moveDrag(e); }, {passive:true});
    board.addEventListener("mousemove", (e)=> { moveDrag(e); });
    board.addEventListener("touchend", ()=> endDrag(), {passive:true});
    board.addEventListener("mouseup", ()=> endDrag());
    board.addEventListener("mouseleave", ()=> endDrag());

    to3.addEventListener("click", ()=> {
      log.ok("STEP 2: Continue clicked -> scroll to Step 3");
      document.getElementById("step3").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // ======= STEP 3: press and hold =======
    const holdBtn = $("holdBtn");
    const bar = $("bar");
    const holdText = $("holdText");
    const final = $("final");
    const b3 = $("b3");

    const HOLD_MS = 3200;
    let holding = false;
    let t0 = 0;
    let raf = null;
    let step3Done = false;

    function tick(){
      if(!holding) return;
      const now = performance.now();
      const p = Math.min(1, (now - t0) / HOLD_MS);
      bar.style.width = (p*100).toFixed(1) + "%";
      holdText.textContent = p < 1 ? "Segura s√≥ mais um pouco‚Ä¶" : "Abrindo‚Ä¶";

      if (Math.round(p*100) % 25 === 0) {
        log.info("STEP 3 progress", { pct: (p*100).toFixed(1) });
      }

      if(p >= 1){
        completeStep3();
        return;
      }
      raf = requestAnimationFrame(tick);
    }

    function startHold(){
      log.group("STEP 3: startHold()");
      if(step3Done){
        log.warn("Already completed");
        log.end();
        return;
      }
      holding = true;
      t0 = performance.now();
      bar.style.width = "0%";
      holdText.textContent = "Segura‚Ä¶ üíõ";
      log.ok("Hold started", { HOLD_MS });
      raf = requestAnimationFrame(tick);
      log.end();
    }

    function cancelHold(){
      if(step3Done) return;
      if(!holding) return;
      log.group("STEP 3: cancelHold()");
      holding = false;
      cancelAnimationFrame(raf);
      bar.style.width = "0%";
      holdText.textContent = "Pressione e segure üíõ";
      log.warn("Hold cancelled");
      log.end();
    }

    function completeStep3(){
      log.group("STEP 3: completeStep3()");
      if(step3Done){
        log.warn("Already completed");
        log.end();
        return;
      }
      step3Done = true;
      holding = false;
      cancelAnimationFrame(raf);
      bar.style.width = "100%";
      holdText.textContent = "Aberto ‚úÖ";
      b3.innerHTML = "‚úÖ <span class='doneMark'>Aberto</span>";
      final.style.display = "block";
      final.scrollIntoView({behavior:"smooth", block:"nearest"});

      if(navigator.vibrate) navigator.vibrate([40,30,40,30,70]);

      log.ok("Step 3 completed -> Final revealed");
      log.end();
    }

    holdBtn.addEventListener("touchstart", (e)=> { e.preventDefault(); startHold(); }, {passive:false});
    holdBtn.addEventListener("touchend", ()=> cancelHold(), {passive:true});
    holdBtn.addEventListener("touchcancel", ()=> cancelHold(), {passive:true});
    holdBtn.addEventListener("mousedown", ()=> startHold());
    window.addEventListener("mouseup", ()=> cancelHold());
  </script>
</body>
</html>
